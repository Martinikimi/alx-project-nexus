<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Store</title>
    <style>
        /* CSS REMOVED - Will add back later when functionality works */
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo" onclick="navigateTo('/'); return false;">E-Store</a>
                <ul class="nav-links">
                    <li><a href="#" onclick="navigateTo('/products'); return false;">Products</a></li>
                    <li><a href="#" onclick="navigateTo('/categories'); return false;">Categories</a></li>
                    <li><a href="#" onclick="navigateTo('/cart'); return false;">Cart <span id="cartCount" class="cart-badge hidden">0</span></a></li>
                    <li id="authLinks">
                        <a href="#" onclick="navigateTo('/login'); return false;">Login</a>
                        <a href="#" onclick="navigateTo('/register'); return false;">Register</a>
                    </li>
                    <li id="userLinks" class="hidden">
                        <a href="#" onclick="navigateTo('/profile'); return false;">Profile</a>
                        <a href="#" onclick="navigateTo('/orders'); return false;">Orders</a>
                        <a href="#" onclick="logout(); return false;">Logout</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Home/Landing Page -->
            <div id="homePage" class="hidden">
                <div class="hero">
                    <h1>Welcome to E-Store</h1>
                    <p>Discover amazing products at unbeatable prices. Shop with confidence and style.</p>
                    <div class="flex justify-center gap-2 mt-3">
                        <button class="btn-primary" onclick="navigateTo('/products')">
                            üõçÔ∏è Start Shopping
                        </button>
                        <button class="btn-secondary" onclick="navigateTo('/categories')">
                            üìÇ Browse Categories
                        </button>
                    </div>
                </div>
                
                <!-- Featured Products Preview -->
                <div class="mt-3">
                    <h2 class="text-center mb-2">Featured Products</h2>
                    <div id="featuredProducts" class="products-grid">
                        <!-- Featured products will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="form-container hidden">
                <h2 class="text-center">üîê Login</h2>
                <form id="loginFormElement">
                    <div class="form-group">
                        <label>üìß Email:</label>
                        <input type="email" id="loginEmail" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>üîí Password:</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn-primary w-full">Login</button>
                </form>
                <div class="text-center mt-2">
                    <p>Don't have an account?</p>
                    <button class="btn-secondary mt-1" onclick="navigateTo('/register')">Create Account</button>
                </div>
                <div id="loginMessage"></div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="form-container hidden">
                <h2 class="text-center">üë§ Register</h2>
                <form id="registerFormElement">
                    <div class="form-group">
                        <label>üìß Email:</label>
                        <input type="email" id="regEmail" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>üë§ Username:</label>
                        <input type="text" id="regUsername" required placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label>üìõ First Name:</label>
                        <input type="text" id="regFirstName" required placeholder="Enter your first name">
                    </div>
                    <div class="form-group">
                        <label>üìõ Last Name:</label>
                        <input type="text" id="regLastName" required placeholder="Enter your last name">
                    </div>
                    <div class="form-group">
                        <label>üìû Phone Number:</label>
                        <input type="tel" id="regPhone" placeholder="Enter your phone number">
                    </div>
                    <div class="form-group">
                        <label>üéÇ Date of Birth:</label>
                        <input type="date" id="regDob" required>
                    </div>
                    <div class="form-group">
                        <label>üè† Address:</label>
                        <textarea id="regAddress" rows="3" placeholder="Enter your address"></textarea>
                    </div>
                    <div class="form-group">
                        <label>üîí Password:</label>
                        <input type="password" id="regPassword" required placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <label>‚úÖ Confirm Password:</label>
                        <input type="password" id="regPasswordConfirm" required placeholder="Confirm your password">
                    </div>
                    <button type="submit" class="btn-success w-full">Create Account</button>
                </form>
                <div class="text-center mt-2">
                    <p>Already have an account?</p>
                    <button class="btn-secondary mt-1" onclick="navigateTo('/login')">Sign In</button>
                </div>
                <div id="registerMessage"></div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="form-container hidden">
                <h2 class="text-center">üë§ User Profile</h2>
                <div id="profileData">
                    <div class="spinner"></div>
                </div>
                <div class="text-center mt-2">
                    <button class="btn-danger" onclick="logout()">üö™ Logout</button>
                </div>
            </div>

            <!-- Products Page -->
            <div id="productsPage" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h2>üõçÔ∏è All Products</h2>
                    <div class="flex gap-1">
                        <button class="btn-secondary" onclick="loadProducts()">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="productsLoading" class="spinner"></div>
                <div id="productsGrid" class="products-grid"></div>
            </div>

            <!-- Categories Page -->
            <div id="categoriesPage" class="hidden">
                <h2 class="text-center mb-2">üìÇ Categories</h2>
                <div id="categoriesLoading" class="spinner"></div>
                <div id="categoriesList" class="products-grid"></div>
            </div>

            <!-- Cart Page -->
            <div id="cartPage" class="hidden">
                <h2 class="text-center mb-2">üõí Shopping Cart</h2>
                <div id="cartItems"></div>
                <div id="cartTotal" class="text-center mt-2"></div>
                <div class="text-center mt-2 flex justify-center gap-2">
                    <button class="btn-success" onclick="navigateTo('/checkout')">
                        üí≥ Proceed to Checkout
                    </button>
                    <button class="btn-danger" onclick="clearCart()">
                        üóëÔ∏è Clear Cart
                    </button>
                </div>
            </div>

            <!-- Checkout Page -->
            <div id="checkoutPage" class="form-container hidden">
                <h2 class="text-center">üí≥ Checkout</h2>
                <div id="checkoutSummary" class="mb-2"></div>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label>üè† Shipping Address:</label>
                        <textarea id="shippingAddress" rows="3" required placeholder="Enter your complete shipping address"></textarea>
                    </div>
                    <button type="submit" class="btn-success w-full">‚úÖ Place Order</button>
                </form>
                <div class="text-center mt-2">
                    <button class="btn-secondary" onclick="navigateTo('/cart')">‚Üê Back to Cart</button>
                </div>
                <div id="checkoutMessage"></div>
            </div>

            <!-- Orders Page -->
            <div id="ordersPage" class="hidden">
                <h2 class="text-center mb-2">üì¶ My Orders</h2>
                <div id="ordersLoading" class="spinner"></div>
                <div id="ordersList"></div>
            </div>

            <!-- Order Detail Page -->
            <div id="orderDetailPage" class="hidden">
                <div id="orderDetailContent"></div>
            </div>

            <!-- Product Detail Page -->
            <div id="productDetailPage" class="hidden">
                <div id="productDetail"></div>
            </div>
        </div>
    </main>

    <!-- Back to Top Button -->
    <a href="#" class="back-to-top" onclick="scrollToTop(); return false;">‚Üë</a>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div>
                    <h3>E-Store</h3>
                    <p>Your trusted online shopping destination</p>
                </div>
                <div>
                    <p>&copy; 2024 E-Store. All rights reserved.</p>
                    <p>Built with ‚ù§Ô∏è for modern e-commerce</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // API Base URLs
        const API_BASE = 'http://127.0.0.1:8000/api';
        const AUTH_API = `${API_BASE}/auth`;
        const PRODUCTS_API = `${API_BASE}/products`;
        const CATEGORIES_API = `${API_BASE}/categories`;
        const CART_API = `${API_BASE}/cart`;
        const ORDERS_API = `${API_BASE}/orders`;
        const PAYMENTS_API = `${API_BASE}/payments`;
        const REVIEWS_API = `${API_BASE}/reviews/create`;

        // Global state
        let currentUser = null;
        let cart = null;
        let products = [];
        let categories = [];
        let currentOrderId = null;

        // URL Routing System
        function navigateTo(path) {
            window.history.pushState({}, '', path);
            showSectionForPath(path);
            updateBackToTopButton();
        }

        function showSectionForPath(path) {
            // Hide all sections
            const sections = [
                'homePage', 'loginForm', 'registerForm', 'profileSection',
                'productsPage', 'categoriesPage', 'cartPage', 'checkoutPage',
                'ordersPage', 'productDetailPage', 'orderDetailPage'
            ];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });

            // Show the correct section based on URL
            switch(path) {
                case '/':
                    document.getElementById('homePage').classList.remove('hidden');
                    loadFeaturedProducts();
                    break;
                case '/login':
                    document.getElementById('loginForm').classList.remove('hidden');
                    break;
                case '/register':
                    document.getElementById('registerForm').classList.remove('hidden');
                    break;
                case '/profile':
                    document.getElementById('profileSection').classList.remove('hidden');
                    loadProfile();
                    break;
                case '/products':
                    document.getElementById('productsPage').classList.remove('hidden');
                    loadProducts();
                    break;
                case '/categories':
                    document.getElementById('categoriesPage').classList.remove('hidden');
                    loadCategories();
                    break;
                case '/cart':
                    document.getElementById('cartPage').classList.remove('hidden');
                    loadCart();
                    break;
                case '/checkout':
                    document.getElementById('checkoutPage').classList.remove('hidden');
                    loadCheckoutSummary();
                    break;
                case '/orders':
                    document.getElementById('ordersPage').classList.remove('hidden');
                    loadOrders();
                    break;
                default:
                    if (path.startsWith('/product/')) {
                        document.getElementById('productDetailPage').classList.remove('hidden');
                        const productId = path.split('/')[2];
                        loadProductDetail(productId);
                    } else if (path.startsWith('/order/')) {
                        document.getElementById('orderDetailPage').classList.remove('hidden');
                        const orderId = path.split('/')[2];
                        loadOrderDetail(orderId);
                    } else {
                        document.getElementById('homePage').classList.remove('hidden');
                        loadFeaturedProducts();
                    }
            }

            updateNavigation();
        }

        // Navigation
        function updateNavigation() {
            const token = localStorage.getItem('access_token');
            const authLinks = document.getElementById('authLinks');
            const userLinks = document.getElementById('userLinks');
            
            if (token) {
                authLinks.classList.add('hidden');
                userLinks.classList.remove('hidden');
            } else {
                authLinks.classList.remove('hidden');
                userLinks.classList.add('hidden');
            }
            
            // Update cart count
            updateCartCount();
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function() {
            showSectionForPath(window.location.pathname);
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('access_token');
            const currentPath = window.location.pathname;
            
            if (token && (currentPath === '/login' || currentPath === '/register')) {
                navigateTo('/');
            } else if (!token && (currentPath === '/profile' || currentPath === '/cart' || currentPath === '/orders' || currentPath === '/checkout')) {
                navigateTo('/login');
            } else {
                showSectionForPath(currentPath);
            }
            
            // Load initial data
            if (token) {
                loadCart();
            }

            // Add scroll event listener for back-to-top button
            window.addEventListener('scroll', updateBackToTopButton);
        });

        // Authentication Functions
        document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };

            try {
                const response = await fetch(`${AUTH_API}/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    showMessage('loginMessage', '‚úÖ Login successful!', 'success');
                    
                    setTimeout(() => {
                        navigateTo('/');
                    }, 1000);
                } else {
                    showMessage('loginMessage', `‚ùå Error: ${data.error || JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showMessage('loginMessage', `‚ùå Network error: ${error.message}`, 'error');
            }
        });

        document.getElementById('registerFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                email: document.getElementById('regEmail').value,
                username: document.getElementById('regUsername').value,
                first_name: document.getElementById('regFirstName').value,
                last_name: document.getElementById('regLastName').value,
                phone_number: document.getElementById('regPhone').value,
                date_of_birth: document.getElementById('regDob').value,
                address: document.getElementById('regAddress').value,
                password: document.getElementById('regPassword').value,
                password_confirm: document.getElementById('regPasswordConfirm').value
            };

            if (formData.password !== formData.password_confirm) {
                showMessage('registerMessage', '‚ùå Passwords do not match!', 'error');
                return;
            }

            try {
                const response = await fetch(`${AUTH_API}/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    showMessage('registerMessage', '‚úÖ Registration successful!', 'success');
                    
                    setTimeout(() => {
                        navigateTo('/');
                    }, 1000);
                } else {
                    showMessage('registerMessage', `‚ùå Error: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showMessage('registerMessage', `‚ùå Network error: ${error.message}`, 'error');
            }
        });

        async function loadProfile() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                navigateTo('/login');
                return;
            }

            try {
                const response = await fetch(`${AUTH_API}/profile/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('profileData').innerHTML = `
                        <div class="form-group">
                            <label>üìß Email:</label>
                            <input type="email" value="${userData.email}" readonly>
                        </div>
                        <div class="form-group">
                            <label>üë§ Username:</label>
                            <input type="text" value="${userData.username}" readonly>
                        </div>
                        <div class="form-group">
                            <label>üìõ First Name:</label>
                            <input type="text" value="${userData.first_name}" readonly>
                        </div>
                        <div class="form-group">
                            <label>üìõ Last Name:</label>
                            <input type="text" value="${userData.last_name}" readonly>
                        </div>
                        <div class="form-group">
                            <label>üìû Phone:</label>
                            <input type="text" value="${userData.phone_number || 'Not provided'}" readonly>
                        </div>
                        <div class="form-group">
                            <label>üéÇ Date of Birth:</label>
                            <input type="text" value="${userData.date_of_birth || 'Not provided'}" readonly>
                        </div>
                        <div class="form-group">
                            <label>üè† Address:</label>
                            <textarea rows="3" readonly>${userData.address || 'Not provided'}</textarea>
                        </div>
                        <div class="form-group">
                            <label>üìÖ Age:</label>
                            <input type="text" value="${userData.age || 'Not available'}" readonly>
                        </div>
                    `;
                } else {
                    await refreshToken();
                    loadProfile();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profileData').innerHTML = `<div class="error">‚ùå Error loading profile</div>`;
            }
        }

        async function logout() {
            const refreshToken = localStorage.getItem('refresh_token');
            
            try {
                await fetch(`${AUTH_API}/logout/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ refresh: refreshToken })
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                navigateTo('/login');
            }
        }

        // Product Functions
        async function loadProducts() {
            const loadingElement = document.getElementById('productsLoading');
            const gridElement = document.getElementById('productsGrid');
            
            loadingElement.classList.remove('hidden');
            gridElement.innerHTML = '';

            try {
                const response = await fetch(`${PRODUCTS_API}/`);
                if (response.ok) {
                    products = await response.json();
                    displayProducts(products);
                } else {
                    throw new Error('Failed to load products');
                }
            } catch (error) {
                gridElement.innerHTML = `<div class="error">‚ùå Error loading products: ${error.message}</div>`;
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        async function loadFeaturedProducts() {
            try {
                const response = await fetch(`${PRODUCTS_API}/featured/`);
                if (response.ok) {
                    const featuredProducts = await response.json();
                    displayFeaturedProducts(featuredProducts.slice(0, 4));
                }
            } catch (error) {
                console.error('Error loading featured products:', error);
            }
        }

        function displayFeaturedProducts(products) {
            const featuredContainer = document.getElementById('featuredProducts');
            if (products.length === 0) {
                featuredContainer.innerHTML = '<div class="info">No featured products available</div>';
                return;
            }

            featuredContainer.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image ? `<img src="${product.image}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">` : 'üì¶'}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">$${product.price}</div>
                        <div class="product-category">${product.category_name}</div>
                        <div class="product-actions">
                            <button class="btn-primary" onclick="addToCart(${product.id})">Add to Cart</button>
                            <button class="btn-secondary" onclick="navigateTo('/product/${product.id}')">View</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayProducts(products) {
            const gridElement = document.getElementById('productsGrid');
            if (products.length === 0) {
                gridElement.innerHTML = '<div class="info">No products found</div>';
                return;
            }

            gridElement.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image ? `<img src="${product.image}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">` : 'üì¶'}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">$${product.price}</div>
                        <div class="product-category">${product.category_name}</div>
                        <div class="product-actions">
                            <button class="btn-primary" onclick="addToCart(${product.id})">Add to Cart</button>
                            <button class="btn-secondary" onclick="navigateTo('/product/${product.id}')">View Details</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadProductDetail(productId) {
            try {
                const response = await fetch(`${PRODUCTS_API}/${productId}/`);
                if (response.ok) {
                    const product = await response.json();
                    displayProductDetail(product);
                }
            } catch (error) {
                document.getElementById('productDetail').innerHTML = `<div class="error">‚ùå Error loading product details</div>`;
            }
        }

        function displayProductDetail(product) {
            document.getElementById('productDetail').innerHTML = `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image ? `<img src="${product.image}" alt="${product.name}" style="width:100%;height:300px;object-fit:cover;">` : 'üì¶'}
                    </div>
                    <div class="product-info">
                        <h2>${product.name}</h2>
                        <div class="product-price">$${product.price}</div>
                        <p><strong>Category:</strong> ${product.category.name}</p>
                        <p><strong>Description:</strong> ${product.description}</p>
                        <p><strong>Stock:</strong> ${product.stock_quantity} available</p>
                        <div class="flex gap-2 mt-2">
                            <button class="btn-primary" onclick="addToCart(${product.id})">Add to Cart</button>
                            <button class="btn-secondary" onclick="navigateTo('/products')">Back to Products</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Category Functions
        async function loadCategories() {
            const loadingElement = document.getElementById('categoriesLoading');
            const listElement = document.getElementById('categoriesList');
            
            loadingElement.classList.remove('hidden');
            listElement.innerHTML = '';

            try {
                const response = await fetch(`${CATEGORIES_API}/`);
                if (response.ok) {
                    categories = await response.json();
                    displayCategories(categories);
                }
            } catch (error) {
                listElement.innerHTML = `<div class="error">‚ùå Error loading categories</div>`;
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        function displayCategories(categories) {
            const listElement = document.getElementById('categoriesList');
            if (categories.length === 0) {
                listElement.innerHTML = '<div class="info">No categories found</div>';
                return;
            }

            listElement.innerHTML = categories.map(category => `
                <div class="product-card">
                    <div class="product-info">
                        <h3>${category.name}</h3>
                        <p class="product-category">${category.description || 'No description available'}</p>
                        <button class="btn-secondary" onclick="navigateTo('/products')">View Products</button>
                    </div>
                </div>
            `).join('');
        }

        // Cart Functions
        async function loadCart() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                document.getElementById('cartItems').innerHTML = '<div class="warning">Please login to view your cart</div>';
                return;
            }

            try {
                const response = await fetch(`${CART_API}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    cart = await response.json();
                    updateCartCount();
                    if (document.getElementById('cartPage').classList.contains('hidden') === false) {
                        displayCart();
                    }
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                document.getElementById('cartItems').innerHTML = '<div class="error">‚ùå Error loading cart</div>';
            }
        }

        function displayCart() {
            const cartItemsElement = document.getElementById('cartItems');
            const cartTotalElement = document.getElementById('cartTotal');

            if (!cart || cart.items.length === 0) {
                cartItemsElement.innerHTML = '<div class="info">üõí Your cart is empty</div>';
                cartTotalElement.innerHTML = '';
                return;
            }

            cartItemsElement.innerHTML = cart.items.map(item => `
                <div class="cart-item">
                    <h4>${item.product_name}</h4>
                    <p>üí∞ Price: $${item.product_price}</p>
                    <div class="quantity-controls">
                        <button class="btn-secondary quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity - 1})">-</button>
                        <span class="quantity-display">${item.quantity}</span>
                        <button class="btn-secondary quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                    <p>üíµ Total: $${item.item_total}</p>
                    <button class="btn-danger" onclick="removeCartItem(${item.id})">üóëÔ∏è Remove</button>
                </div>
            `).join('');

            cartTotalElement.innerHTML = `
                <div class="success">
                    <h3>üí∞ Cart Total: $${cart.cart_total}</h3>
                    <p>üì¶ Total Items: ${cart.total_items}</p>
                </div>
            `;
        }

        function updateCartCount() {
            const cartCountElement = document.getElementById('cartCount');
            if (cart && cart.total_items > 0) {
                cartCountElement.textContent = cart.total_items;
                cartCountElement.classList.remove('hidden');
            } else {
                cartCountElement.classList.add('hidden');
            }
        }

        async function addToCart(productId) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showMessage('productsPage', 'üîí Please login to add items to cart', 'warning');
                navigateTo('/login');
                return;
            }

            try {
                const response = await fetch(`${CART_API}/add/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: 1
                    })
                });

                if (response.ok) {
                    await loadCart();
                    showMessage('productsPage', '‚úÖ Product added to cart!', 'success');
                } else {
                    throw new Error('Failed to add to cart');
                }
            } catch (error) {
                showMessage('productsPage', '‚ùå Error adding to cart', 'error');
            }
        }

        async function updateCartItem(itemId, newQuantity) {
            if (newQuantity < 1) {
                removeCartItem(itemId);
                return;
            }

            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${CART_API}/items/${itemId}/update/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quantity: newQuantity
                    })
                });

                if (response.ok) {
                    await loadCart();
                }
            } catch (error) {
                console.error('Error updating cart item:', error);
                showMessage('cartPage', '‚ùå Error updating quantity', 'error');
            }
        }

        async function removeCartItem(itemId) {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${CART_API}/items/${itemId}/remove/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    await loadCart();
                    displayCart();
                    showMessage('cartPage', '‚úÖ Item removed from cart', 'success');
                }
            } catch (error) {
                console.error('Error removing cart item:', error);
                showMessage('cartPage', '‚ùå Error removing item', 'error');
            }
        }

        async function clearCart() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${CART_API}/clear/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    await loadCart();
                    displayCart();
                    showMessage('cartPage', '‚úÖ Cart cleared successfully', 'success');
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                showMessage('cartPage', '‚ùå Error clearing cart', 'error');
            }
        }

        // Checkout Functions
        function loadCheckoutSummary() {
            const summaryElement = document.getElementById('checkoutSummary');
            if (!cart || cart.items.length === 0) {
                summaryElement.innerHTML = '<div class="warning">üõí Your cart is empty</div>';
                return;
            }

            summaryElement.innerHTML = `
                <div class="info">
                    <h4>üì¶ Order Summary</h4>
                    <p>Total Items: ${cart.total_items}</p>
                    <p>Total Amount: $${cart.cart_total}</p>
                </div>
            `;
        }

        // Order Functions
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('access_token');
            const shippingAddress = document.getElementById('shippingAddress').value;

            if (!cart || cart.items.length === 0) {
                showMessage('checkoutMessage', '‚ùå Your cart is empty', 'error');
                return;
            }

            try {
                const response = await fetch(`${ORDERS_API}/create/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        shipping_address: shippingAddress
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showMessage('checkoutMessage', `‚úÖ Order created successfully! Order #${data.order_number}`, 'success');
                    await loadCart();
                    setTimeout(() => {
                        navigateTo('/orders');
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create order');
                }
            } catch (error) {
                showMessage('checkoutMessage', `‚ùå Error: ${error.message}`, 'error');
            }
        });

        async function loadOrders() {
            const token = localStorage.getItem('access_token');
            const loadingElement = document.getElementById('ordersLoading');
            const listElement = document.getElementById('ordersList');
            
            if (!token) {
                navigateTo('/login');
                return;
            }

            loadingElement.classList.remove('hidden');
            listElement.innerHTML = '';

            try {
                const response = await fetch(`${ORDERS_API}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const orders = await response.json();
                    displayOrders(orders);
                }
            } catch (error) {
                listElement.innerHTML = `<div class="error">‚ùå Error loading orders</div>`;
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        function displayOrders(orders) {
            const ordersListElement = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersListElement.innerHTML = '<div class="info">üì≠ No orders found</div>';
                return;
            }

            ordersListElement.innerHTML = orders.map(order => `
                <div class="order-item">
                    <h4>üì¶ Order #${order.order_number}</h4>
                    <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status}</span></p>
                    <p><strong>Total:</strong> $${order.total_amount}</p>
                    <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleDateString()}</p>
                    <p><strong>Items:</strong> ${order.total_items}</p>
                    <div class="order-actions">
                        <button class="btn-secondary" onclick="navigateTo('/order/${order.id}')">üìã View Details</button>
                        ${order.status === 'delivered' ? `
                            <button class="btn-warning" onclick="requestRefund(${order.id})">üí∞ Request Refund</button>
                            <button class="btn-info" onclick="showReviewForm(${order.id})">‚≠ê Write Review</button>
                        ` : ''}
                        ${order.status === 'pending' ? `
                            <button class="btn-danger" onclick="cancelOrder(${order.id})">‚ùå Cancel Order</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadOrderDetail(orderId) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                navigateTo('/login');
                return;
            }

            try {
                const response = await fetch(`${ORDERS_API}/${orderId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const order = await response.json();
                    displayOrderDetail(order);
                }
            } catch (error) {
                document.getElementById('orderDetailContent').innerHTML = `<div class="error">‚ùå Error loading order details</div>`;
            }
        }

        function displayOrderDetail(order) {
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="order-details">
                    <div class="flex justify-between items-center mb-4">
                        <h2>üìã Order #${order.order_number}</h2>
                        <span class="status-badge status-${order.status}">${order.status}</span>
                    </div>
                    
                    <div class="grid-2">
                        <div>
                            <h4>üì¶ Order Information</h4>
                            <p><strong>Order Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                            <p><strong>Total Amount:</strong> $${order.total_amount}</p>
                            <p><strong>Total Items:</strong> ${order.total_items}</p>
                        </div>
                        <div>
                            <h4>üè† Shipping Address</h4>
                            <p>${order.shipping_address}</p>
                        </div>
                    </div>

                    <div class="order-items">
                        <h4>üõçÔ∏è Order Items</h4>
                        ${order.items ? order.items.map(item => `
                            <div class="order-item-detail">
                                <div>
                                    <strong>${item.product_name}</strong>
                                    <p>Quantity: ${item.quantity}</p>
                                </div>
                                <div class="text-right">
                                    <p>$${item.product_price} each</p>
                                    <strong>$${(item.product_price * item.quantity).toFixed(2)}</strong>
                                </div>
                            </div>
                        `).join('') : '<p>No items found</p>'}
                    </div>

                    <div class="order-actions">
                        <button class="btn-secondary" onclick="navigateTo('/orders')">‚Üê Back to Orders</button>
                        ${order.status === 'delivered' ? `
                            <button class="btn-warning" onclick="requestRefund(${order.id})">üí∞ Request Refund</button>
                            <button class="btn-info" onclick="showReviewForm(${order.id})">‚≠ê Write Review</button>
                        ` : ''}
                        ${order.status === 'pending' ? `
                            <button class="btn-danger" onclick="cancelOrder(${order.id})">‚ùå Cancel Order</button>
                        ` : ''}
                    </div>
                </div>

                ${order.status === 'delivered' ? `
                    <div id="reviewSection" class="hidden">
                        <div class="review-form">
                            <h4>‚≠ê Write a Review</h4>
                            <div class="rating-stars">
                                ${[1,2,3,4,5].map(star => `
                                    <span class="star" onclick="setRating(${star})">‚òÖ</span>
                                `).join('')}
                            </div>
                            <div class="form-group">
                                <label>Review Comment:</label>
                                <textarea id="reviewComment" rows="3" placeholder="Share your experience with this product..."></textarea>
                            </div>
                            <button class="btn-success" onclick="submitReview(${order.id})">Submit Review</button>
                            <button class="btn-secondary" onclick="hideReviewForm()">Cancel</button>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Order Actions
        async function requestRefund(orderId) {
            if (!confirm('Are you sure you want to request a refund for this order?')) return;

            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${ORDERS_API}/${orderId}/refund/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    showMessage('orderDetailContent', '‚úÖ Refund request submitted successfully!', 'success');
                    setTimeout(() => {
                        loadOrderDetail(orderId);
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to request refund');
                }
            } catch (error) {
                showMessage('orderDetailContent', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;

            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${ORDERS_API}/${orderId}/cancel/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    showMessage('orderDetailContent', '‚úÖ Order cancelled successfully!', 'success');
                    setTimeout(() => {
                        loadOrderDetail(orderId);
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to cancel order');
                }
            } catch (error) {
                showMessage('orderDetailContent', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Review Functions - UPDATED VERSION
        let currentRating = 0;

        function showReviewForm(orderId) {
            currentOrderId = orderId;
            document.getElementById('reviewSection').classList.remove('hidden');
        }

        function hideReviewForm() {
            document.getElementById('reviewSection').classList.add('hidden');
            currentRating = 0;
            updateStars();
        }

        function setRating(rating) {
            currentRating = rating;
            updateStars();
        }

        function updateStars() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < currentRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function submitReview(orderId) {
            const token = localStorage.getItem('access_token');
            const comment = document.getElementById('reviewComment').value;

            if (currentRating === 0) {
                showMessage('reviewSection', '‚ùå Please select a rating', 'error');
                return;
            }

            try {
                // Get the order details first
                const orderResponse = await fetch(`${ORDERS_API}/${orderId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (!orderResponse.ok) {
                    throw new Error('Failed to fetch order details');
                }

                const order = await orderResponse.json();
                
                // Extract product ID from the order items
                let productId = null;
                
                if (order.items && order.items.length > 0) {
                    // Try to get product ID from the first item
                    const firstItem = order.items[0];
                    
                    // Check all possible field names where product ID might be stored
                    if (firstItem.product_id) {
                        productId = firstItem.product_id;
                    } else if (firstItem.product && firstItem.product.id) {
                        productId = firstItem.product.id;
                    } else if (firstItem.product) {
                        productId = firstItem.product;
                    } else if (firstItem.id) {
                        productId = firstItem.id;
                    }
                }

                if (!productId) {
                    throw new Error('Could not find product ID in order. Please contact support.');
                }

                // Submit the review
                const response = await fetch(`${REVIEWS_API}/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        rating: currentRating,
                        comment: comment
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('reviewSection', '‚úÖ Review submitted successfully!', 'success');
                    hideReviewForm();
                } else {
                    throw new Error(data.detail || data.error || 'Failed to submit review');
                }
            } catch (error) {
                console.error('Review submission error:', error);
                showMessage('reviewSection', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Utility Functions
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const existingMessage = container.querySelector('.error, .success, .info, .warning');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = type;
            messageElement.innerHTML = message;
            container.insertBefore(messageElement, container.firstChild);

            if (type === 'success') {
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 5000);
            }
        }

        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            
            try {
                const response = await fetch(`${AUTH_API}/token/refresh/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh: refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    return true;
                } else {
                    throw new Error('Token refresh failed');
                }
            } catch (error) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                navigateTo('/login');
                return false;
            }
        }

        // Back to Top functionality
        function updateBackToTopButton() {
            const backToTopButton = document.querySelector('.back-to-top');
            if (window.scrollY > 300) {
                backToTopButton.classList.add('visible');
            } else {
                backToTopButton.classList.remove('visible');
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // View order details
        function viewOrderDetails(orderId) {
            navigateTo(`/order/${orderId}`);
        }
    </script>
</body>
</html>